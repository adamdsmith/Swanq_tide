{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Bell Island Pier water level visualization\"\noutput:\n  html_document:\n    fig_width: 10\n    fig_height: 2\n---\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)\noptions(scipen = 999, stringsAsFactors = FALSE)\n\nncdc <- \"BvCqJZBhVjtoLSvZIzWarGmRMVTJBPjr\"\n\n# Loading required packages\npacman::p_load(readr, readxl, dplyr, lubridate, dygraphs, rnoaa, RCurl, ggplot2, shiny, zoo, viridis)\n\n# Load utility functions\nsource(\"./R/utils.R\")\n\n# Set colors\ncolors <- substr(viridis(3, alpha = 0, end = 0.8, option = \"B\"), 1, 7)\n```\n\nCompare water level, sea surface temperature, and salinity from sonde deployment at [Bell Island fishing pier](https://goo.gl/maps/ib3hbgEAgpv) on Swanquarter NWR with those at the [Pungo River in Bellhaven, NC](https://mesonet.agron.iastate.edu/sites/site.php?station=BLHN7&network=NC_DCP) and [USCG Station Hatteras](http://tidesandcurrents.noaa.gov/stationhome.html?id=8654467).\n\n### Legend  \n\n- <strong style=\"color: #000004;\">Bell Island Pier</strong>\n- <strong style=\"color: #932667;\">Pungo River @ Bellhaven</strong>\n- <strong style=\"color: #FCA50A;\">Cape Hatteras</strong>\n\n```{r caha_tide}\n# Retrieve USCG Station Hatteras tide gage data\n# caha <- get_tides()\n# save(caha, file = \"./Data/caha_gage.rda\")\nload(\"./Data/caha_gage.rda\")\ncaha <- caha %>%\n  # Thin to measurements @ top and bottom of hour\n  filter(minute(dt) %in% c(0, 30))\n```\n\n```{r caha_wx}\n# From CAHA buoy, we can get matched (to tide) wind speed, direction, and SST\n# caha_wx <- get_buoy_wx(endday = \"06/26/2017\")\n# \n# caha_prcp <- ghcnd_search(stationid = \"USW00093729\",\n#                           date_min = \"2013-05-01\", # for some reason, use day before start\n#                           #date_max = \"2015-12-01\",\n#                           var = \"PRCP\")[[1]] %>%\n#   mutate(date = ymd(date),\n#          daily_prcp = round(prcp / 100 / 2.54, 2)) %>% # convert to inches\n#   select(date, daily_prcp) %>% arrange(date) %>% as.data.frame()\n# \n# save(caha_wx, caha_prcp, file = \"./Data/caha_wx.rda\")\nload(\"./Data/caha_wx.rda\")\ncaha_wx <- caha_wx %>%\n  # Thin to measurements @ top and bottom of hour\n  filter(minute(dt) %in% c(0, 30))\n```\n\n\n```{r bell_tide}\n# Load spreadsheets and convert to usable format\nbell <- read_csv(\"./Data/bell_island.csv\", col_types = \"ccnnnnnnn\",\n                 na = c(\"\", \"NA\", \"NaN\")) %>%\n  mutate(dt = round_date(ymd_hm(paste(date, time_24h), tz = \"Etc/GMT+5\"), \"minute\")) %>%\n  select(dt, bell_sst = temp_c, bell_sal = sal_ppt, bell_wl = depth_navd88_m) %>%\n  # Thin to measurements @ top and bottom of hour\n  filter(minute(dt) %in% c(0, 30)) %>%\n  # Add unused date/time to break up series\n  add_row(dt = ymd_hm(\"2015/01/01 12:34\")) %>%\n  as.data.frame()\nattr(bell$dt, \"tzone\") <- \"GMT\"\n```\n\n```{r pungo_tide}\n# Load data\n# Acquired: https://mesonet.agron.iastate.edu/request/dcp/fe.phtml?network=NC_DCP\n# url <- \"https://mesonet.agron.iastate.edu/cgi-bin/request/hads.py?network=NC_DCP&stations=BLHN7&year=%s&month1=1&day1=1&hour1=0&minute1=0&month2=12&day2=31&hour2=23&minute2=59&what=text&delim=comma&threshold=&threshold-var=RG\"\n# pungo <- lapply(2013:2017, function(yr) {\n#   message(\"Processing \", yr)\n#   x <- getURL(sprintf(url, yr), ssl.verifypeer = FALSE) %>%\n#     textConnection() %>% read.csv() %>%\n#     filter(!is.na(HGIRGZ)) %>%\n#     mutate(dt = ymd_hms(utc_valid), # assigns correctly as UTC\n#            # Likely just to piss me off, a gage correction of -2.4 feet was \n#            # applied starting at 2014-11-01 14:30 (or 2014.835 in decimal_date)\n#            pungo_wl = ifelse(decimal_date(dt) < 2014.835,\n#                              (HGIRGZ - 2.4) / 3.28084,\n#                              HGIRGZ/3.28084)) %>% # Adjust to NAVD88 and convert to m\n#   select(dt, pungo_wl)\n#   x\n# })\n# pungo <- bind_rows(pungo)\n# save(pungo, file = \"./Data/pungo.rda\") # last updated 2017-06-27\nload(\"./Data/pungo.rda\")\npungo <- pungo %>%\n  mutate(dt = round_date(dt, \"3 minutes\")) %>%\n  # Occassionally Pungo measurements occur @ 1 or 31 minutes after the hour\n  # Round these to 0 and 30 and drop missing values\n  # Thin to measurements @ top and bottom of hour\n  filter(minute(dt) %in% c(0, 30),\n         pungo_wl < 1.5) # Some occassional weird values and I'm too lazy to remove them more intelligently\n```\n\n```{r dygraphs}\n### Water level dygraph\n# Join the relevant data\nwl_ts <- bell[, c(\"dt\", \"bell_wl\")] %>% left_join(pungo, by = \"dt\") %>%\n  left_join(caha[, c(\"dt\", \"wl\")], by = \"dt\") %>%\n  arrange(dt)\nattr(wl_ts$dt, \"tzone\") <- \"Etc/GMT+5\"\ninit_window <- as.character(c(max(wl_ts$dt) - days(14), max(wl_ts$dt)))\n\nwl_ts <- wl_ts %>%\n  read.zoo(format = \"%Y-%m-%d %H:%M:%S\", tz = \"Etc/GMT+5\") %>%\n  round(3)\n\n# Make the dygraph\ndygraph(wl_ts, group = \"wl\") %>%\n  dyOptions(colors = colors,\n            axisLineWidth = 2, connectSeparatedPoints = FALSE,\n            strokeWidth = 1.5) %>%\n  dyAxis(\"y\", label = \"Water level (NAVD88 m)\") %>%\n  dySeries(\"bell_wl\", label = \"Bell\") %>%\n  dySeries(\"pungo_wl\", label = \"Pungo\") %>%\n  dySeries(\"wl\", label = \"Hatteras\") %>%\n  dyLegend(show = \"follow\", width = 400) %>%\n  dyRangeSelector(height = 20, strokeColor = \"\", dateWindow = init_window)\n\n### Sea surface temperature dygraph\n# Join the relevant data\nsst_ts <- bell[, c(\"dt\", \"bell_sst\")] %>% left_join(caha_wx[, c(\"dt\", \"sst\")], by = \"dt\") %>% \n  arrange(dt)\nattr(sst_ts$dt, \"tzone\") <- \"Etc/GMT+5\"\n\nsst_ts <- sst_ts %>%\n  read.zoo(format = \"%Y-%m-%d %H:%M:%S\", tz = \"Etc/GMT+5\") %>%\n  round(2)\n\n# Make the dygraph\ndygraph(sst_ts, group = \"wl\") %>%\n  dyOptions(colors = colors[c(1,3)],\n            axisLineWidth = 2, connectSeparatedPoints = FALSE,\n            strokeWidth = 1.5) %>%\n  dyAxis(\"y\", label = \"Sea surface temperature (C)\") %>%\n  dySeries(\"bell_sst\", label = \"Bell\") %>%\n  dySeries(\"sst\", label = \"Hatteras\") %>%\n  dyLegend(show = \"follow\", width = 400) %>%\n  dyRangeSelector(height = 20, strokeColor = \"\", dateWindow = init_window)\n\n### Salinity\n# Create the time series\nsal_ts <- bell[, c(\"dt\", \"bell_sal\")] %>% \n  mutate(date = as.Date(dt)) %>%\n  left_join(caha_prcp, by = \"date\") %>% \n  select(-date) %>% arrange(dt) %>%\n  mutate(daily_prcp = daily_prcp * 2.54)\nattr(sal_ts$dt, \"tzone\") <- \"Etc/GMT+5\"\n\n# Set precip on \"time series beaking date\" to missing...\nneeds_na <- which(month(sal_ts$dt) == 1 & year(sal_ts$dt) == 2015)\nsal_ts[needs_na, \"daily_prcp\"] <- NA\n\nsal_ts <- sal_ts %>%\n  read.zoo(format = \"%Y-%m-%d %H:%M:%S\", tz = \"Etc/GMT+5\") %>%\n  round(2)\n\n# Make the dygraph\ndygraph(sal_ts, group = \"wl\") %>%\n  dyOptions(colors = colors[c(1,3)], connectSeparatedPoints = FALSE,\n            axisLineWidth = 2, strokeWidth = 1.5) %>%\n  dyAxis(\"y\", label = \"Salinity (ppt)<br>24-h rainfall (cm)\") %>%\n  dySeries(\"bell_sal\", label = \"Bell\") %>%\n  dySeries(\"daily_prcp\", label = \"24-h rainfall\", stepPlot = TRUE, fillGraph = TRUE,\n           color = colors[3]) %>%\n  dyLegend(show = \"follow\", width = 400) %>%\n  dyRangeSelector(height = 20, strokeColor = \"\", dateWindow = init_window)\n\n# markdown::rpubsUpload(\"Bell Island Pier water level visualization\",\n#                       \"SQ_water_dygraph.html\",\n#                       \"https://api.rpubs.com/api/v1/document/224096/6745a7f28c4e436ebb33052dd956699f\",\n#                       method = \"internal\")\n\n```",
    "created" : 1478187996114.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3585540401",
    "id" : "3AF2274B",
    "lastKnownWriteTime" : 1498761332,
    "last_content_update" : 1498761332846,
    "path" : "~/FWS_Projects/Swanq_tide/SQ_water_dygraph.Rmd",
    "project_path" : "SQ_water_dygraph.Rmd",
    "properties" : {
        "last_setup_crc32" : "B089F815b4454e94",
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}